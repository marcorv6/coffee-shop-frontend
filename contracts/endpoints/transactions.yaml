# Transactions Endpoints - Maloca Coffee Shop
# Payment transactions and financial records

paths:
  /transactions:
    get:
      tags:
        - Transactions
      summary: Listar transacciones
      description: |
        Obtiene la lista de transacciones con filtros.
        Incluye estadísticas agregadas del período.
      operationId: listTransactions
      parameters:
        - name: startDate
          in: query
          description: Fecha inicio (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          description: Fecha fin (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: paymentMethod
          in: query
          description: Filtrar por método de pago
          schema:
            type: string
            enum:
              - cash
              - card
              - wallet
        - name: status
          in: query
          description: Filtrar por estado
          schema:
            type: string
            enum:
              - completed
              - refunded
              - voided
        - name: type
          in: query
          description: Filtrar por tipo
          schema:
            type: string
            enum:
              - sale
              - refund
              - void
        - name: locationId
          in: query
          description: Filtrar por ubicación
          schema:
            type: string
        - name: staffId
          in: query
          description: Filtrar por empleado
          schema:
            type: string
        - name: minAmount
          in: query
          description: Monto mínimo
          schema:
            type: number
        - name: maxAmount
          in: query
          description: Monto máximo
          schema:
            type: number
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: Lista de transacciones
          content:
            application/json:
              schema:
                $ref: '../schemas/transaction.yaml#/components/schemas/TransactionListResponse'
        '401':
          $ref: '../openapi.yaml#/components/responses/UnauthorizedError'

  /transactions/{id}:
    get:
      tags:
        - Transactions
      summary: Obtener transacción
      description: Obtiene los detalles de una transacción
      operationId: getTransaction
      parameters:
        - name: id
          in: path
          required: true
          description: ID de la transacción
          schema:
            type: string
      responses:
        '200':
          description: Transacción encontrada
          content:
            application/json:
              schema:
                type: object
                properties:
                  transaction:
                    $ref: '../schemas/transaction.yaml#/components/schemas/Transaction'
                  order:
                    $ref: '../schemas/order.yaml#/components/schemas/Order'
                    description: Pedido asociado
        '401':
          $ref: '../openapi.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: '../openapi.yaml#/components/responses/NotFoundError'

  /transactions/{id}/refund:
    post:
      tags:
        - Transactions
      summary: Procesar reembolso
      description: |
        Procesa un reembolso total o parcial de una transacción.
        Crea una nueva transacción de tipo 'refund'.
      operationId: refundTransaction
      parameters:
        - name: id
          in: path
          required: true
          description: ID de la transacción original
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/transaction.yaml#/components/schemas/TransactionRefundRequest'
            example:
              reason: "Producto defectuoso"
              amount: 45.50
              staffId: "ML-8821"
      responses:
        '200':
          description: Reembolso procesado
          content:
            application/json:
              schema:
                $ref: '../schemas/transaction.yaml#/components/schemas/TransactionRefundResponse'
        '400':
          description: Error en reembolso
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Error'
              examples:
                already_refunded:
                  value:
                    code: "ALREADY_REFUNDED"
                    message: "Esta transacción ya fue reembolsada"
                invalid_amount:
                  value:
                    code: "INVALID_REFUND_AMOUNT"
                    message: "El monto de reembolso excede el monto original"
        '401':
          $ref: '../openapi.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: '../openapi.yaml#/components/responses/NotFoundError'

  /transactions/summary/daily:
    get:
      tags:
        - Transactions
      summary: Resumen diario
      description: |
        Obtiene el resumen de transacciones de un día.
        Incluye desglose por método de pago y por hora.
      operationId: getDailySummary
      parameters:
        - name: date
          in: query
          description: Fecha del resumen (YYYY-MM-DD). Default = hoy
          schema:
            type: string
            format: date
        - name: locationId
          in: query
          description: Filtrar por ubicación
          schema:
            type: string
      responses:
        '200':
          description: Resumen diario
          content:
            application/json:
              schema:
                $ref: '../schemas/transaction.yaml#/components/schemas/DailySummary'
              example:
                date: "2024-01-16"
                totalRevenue: 8450.50
                transactionCount: 156
                averageTicket: 54.17
                byPaymentMethod:
                  cash:
                    total: 2500.00
                    count: 45
                    percentage: 29.6
                  card:
                    total: 4500.50
                    count: 85
                    percentage: 53.3
                  wallet:
                    total: 1450.00
                    count: 26
                    percentage: 17.1
                byHour:
                  - hour: 7
                    revenue: 450.00
                    count: 12
                  - hour: 8
                    revenue: 1200.50
                    count: 35
                  - hour: 9
                    revenue: 980.00
                    count: 28
                comparison:
                  revenueChange: 12.5
                  countChange: 8.2
        '401':
          $ref: '../openapi.yaml#/components/responses/UnauthorizedError'

  /transactions/export:
    get:
      tags:
        - Transactions
      summary: Exportar transacciones
      description: |
        Genera un archivo exportable de transacciones.
        Formatos disponibles: CSV, PDF, XLSX.
      operationId: exportTransactions
      parameters:
        - name: startDate
          in: query
          required: true
          description: Fecha inicio (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          required: true
          description: Fecha fin (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: format
          in: query
          required: true
          description: Formato del archivo
          schema:
            type: string
            enum:
              - csv
              - pdf
              - xlsx
        - name: locationId
          in: query
          description: Filtrar por ubicación
          schema:
            type: string
        - name: paymentMethod
          in: query
          description: Filtrar por método de pago
          schema:
            type: string
            enum:
              - cash
              - card
              - wallet
      responses:
        '200':
          description: Archivo generado
          content:
            application/json:
              schema:
                $ref: '../schemas/transaction.yaml#/components/schemas/TransactionExportResponse'
              example:
                downloadUrl: "https://storage.googleapis.com/maloca/exports/txn_2024-01-16_abc123.xlsx"
                expiresAt:
                  _seconds: 1705449600
                  _nanoseconds: 0
                recordCount: 672
        '400':
          description: Rango de fechas inválido
          content:
            application/json:
              schema:
                $ref: '../openapi.yaml#/components/schemas/Error'
              example:
                code: "INVALID_DATE_RANGE"
                message: "El rango máximo de exportación es 90 días"
        '401':
          $ref: '../openapi.yaml#/components/responses/UnauthorizedError'
